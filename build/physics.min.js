/**
 * Physics
 * A requirified port of Traer Physics from Processing to JavaScript.
 * Copyright (C) 2012 jonobr1
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
var physics=physics||{};
common=function(){var c=Object.prototype.hasOwnProperty,d=function(e,c,a){if(null!=e)if(nativeForEach&&e.forEach===nativeForEach)e.forEach(c,a);else if(e.length===+e.length)for(var b=0,g=e.length;b<g&&!(b in e&&c.call(a,e[b],b,e)===breaker);b++);else for(b in e)if(_.has(e,b)&&c.call(a,e[b],b,e)===breaker)break};return{has:function(e,d){return c.call(e,d)},each:d,extend:function(c){d(slice.call(arguments,l),function(d){for(var a in d)c[a]=d});return c},isNumber:function(c){return"[object Number]"==toString.call(c)},
isFunction:function(c){return"[object Function]"==toString.call(c)}}}();
physics.System=System=function(c,d,e){function f(){var a=this;this.tick();e.each(this.animations,function(a){e.isFunction(a.update)&&a.update()});this.__equilibrium||d(function(){f.call(a)})}var a=function(){c.ParticleSystem.apply(this,arguments);this.animations=[]};a.Traer=c;e.extend(a.prototype,c.ParticleSystem.prototype,{update:function(){this.__equilibrium&&(this.__equilibrium=!1,f.call(this));return this}});a=new a;f.call(a);return a}(Traer=function(c,d){function e(a){this.s=a;this.originalPositions=
[];this.originalVelocities=[];this.k1Forces=[];this.k1Velocities=[];this.k2Forces=[];this.k2Velocities=[];this.k3Forces=[];this.k3Velocities=[];this.k4Forces=[];this.k4Velocities=[]}var f={Particle:function(a){this.position=new c;this.velocity=new c;this.force=new c;this.mass=a;this.fixed=!1;this.age=0;this.dead=!1}};d.extend(f.Particle.prototype,{distanceTo:function(a){return this.position.distanceTo(a.position)},makeFixed:function(){this.fixed=!0;this.velocity.clear()},reset:function(){this.age=
0;this.dead=!1;this.position.clear();this.velocity.clear();this.force.clear();this.mass=1},resting:function(){return this.fixed||this.velocity.isZero()&&this.force.isZero()}});f.Spring=function(a,b,g,c,h){this.constant=g;this.damping=c;this.length=h;this.a=a;this.b=b;this.on=!0};d.extend(f.Spring.prototype,{currentLength:function(){return this.a.position.distanceTo(this.b.position)},update:function(){var a=this.a,b=this.b;if(!this.on||a.fixed&&b.fixed)return this;var g=(new c).sub(a.position,b.position),
d=g.length();0===d?g.clear():g.divideScalar(d);var d=-1*(d-this.length)*this.constant,h=(new c).sub(a.velocity,b.velocity),h=-1*this.damping*h.dot(g);g.multiplyScalar(d+h);a.fixed||a.force.addSelf(g);b.fixed||b.force.subSelf(g);return this},resting:function(){var a=this.a,b=this.b,c=this.length;return a.fixed&&b.fixed||a.fixed&&(0===c?b.position.equals(a.position):b.position.distanceTo(a.position)<=c)&&b.resting()||b.fixed&&(0===c?a.position.equals(b.position):a.position.distanceTo(b.position)<=c)&&
a.resting()}});f.Attraction=function(a,b,c,d){this.a=a;this.b=b;this.constant=c;this.on=!0;this.distanceMin=d;this.distanceMinSquared=d*d};d.extend(f.Attraction.prototype,{update:function(){var a=this.a,b=this.b;if(this.on&&(!a.fixed||!b.fixed)){var d=(new c).sub(a.position,b.position),e=Math.max(d.lengthSq(),this.distanceMinSquared),h=this.constant*a.mass*b.mass/e,e=Math.sqrt(e);0===h||0===e?d.clear():d.divideScalar(e).multiplyScalar(h);a.fixed||a.force.subSelf(d);b.fixed||b.force.addSelf(d);return this}},
resting:function(){var a=this.a,b=this.b,c=this.distanceMin;return a.fixed&&b.fixed||a.fixed&&b.position.distanceTo(a.position)<=c&&b.resting()||b.fixed&&a.position.distanceTo(b.position)<=c&&a.resting()}});f.ParticleSystem=function(){this.__equilibrium=!1;this.particles=[];this.springs=[];this.attractions=[];this.forces=[];this.integrator=new e(this);this.hasDeadParticles=!1;var a=arguments.length;2===a?(this.gravity=new c(0,arguments[0]),this.drag=arguments[1]):3===a?(this.gravity=new c(arguments[0],
arguments[1]),this.drag=arguments[3]):(this.gravity=new c(0,f.ParticleSystem.DEFAULT_GRAVITY),this.drag=f.ParticleSystem.DEFAULT_DRAG)};d.extend(f.ParticleSystem,{DEFAULT_GRAVITY:0,DEFAULT_DRAG:0.001});d.extend(f.ParticleSystem.prototype,{setGravity:function(a,b){this.gravity.set(a,b);return this},tick:function(){this.integrator.step(0===arguments.length?1:arguments[0]);this.__equilibrium=!this.needsUpdate();return this},needsUpdate:function(){needsUpdate=!1;for(var a=0,b=this.springs.length;a<b;a++)if(!this.springs[a].resting()){needsUpdate=
!0;break}if(!needsUpdate){a=0;for(b=this.attractions.length;a<b;a++)if(!this.attractions[a].resting()){needsUpdate=!0;break}}return needsUpdate},addParticle:function(a){this.particles.push(a);return this},addSpring:function(a){this.springs.push(a);return this},addAttraction:function(a){this.attractions.push(a);return this},makeParticle:function(a,b,c){a=d.isNumber(a)?a:1;b=b||0;c=c||0;a=new f.Particle(a);a.position.set(b,c);this.addParticle(a);return a},makeSpring:function(a,b,c,d,h){a=new f.Spring(a,
b,c,d,h);this.addSpring(a);return a},makeAttraction:function(a,b,c,d){a=new f.Attraction(a,b,c,d);this.addAttraction(a);return a},clear:function(){this.particles.length=0;this.springs.length=0;this.attractions.length=0},applyForces:function(){this.gravity.isZero()||d.each(this.particles,function(a){a.force.addSelf(this.gravity)},this);var a=new c;d.each(this.particles,function(b){a.set(-1*b.velocity.x*this.drag,-1*b.velocity.y*this.drag);b.force.addSelf(a)},this);d.each(this.springs,function(a){a.update()});
d.each(this.attractions,function(a){a.update()});d.each(this.forces,function(a){a.update()});return this},clearForces:function(){d.each(this.particles,function(a){a.clear()});return this}});d.extend(e.prototype,{allocateParticles:function(){for(;this.s.particles.length>this.originalPositions.length;)this.originalPositions.push(new c),this.originalVelocities.push(new c),this.k1Forces.push(new c),this.k1Velocities.push(new c),this.k2Forces.push(new c),this.k2Velocities.push(new c),this.k3Forces.push(new c),
this.k3Velocities.push(new c),this.k4Forces.push(new c),this.k4Velocities.push(new c);return this},step:function(a){var b=this.s,c,e;this.allocateParticles();d.each(b.particles,function(a,b){a.fixed||(this.originalPositions[b].copy(a.position),this.originalVelocities[b].copy(a.velocity));a.force.clear()},this);b.applyForces();d.each(b.particles,function(a,b){a.fixed||(this.k1Forces[b].copy(a.force),this.k1Velocities[b].copy(a.velocity));a.force.clear()},this);d.each(b.particles,function(b,d){if(!b.fixed){var i=
this.originalPositions[d],j=this.k1Velocities[d];c=i.x+0.5*j.x*a;e=i.y+0.5*j.y*a;b.position.set(c,e);i=this.originalVelocities[d];j=this.k1Forces[d];c=i.x+0.5*j.x*a/b.mass;e=i.y+0.5*j.y*a/b.mass;b.velocity.set(c,e)}},this);b.applyForces();d.each(b.particles,function(a,b){a.fixed||(this.k2Forces[b].copy(a.force),this.k2Velocities[b].copy(a.velocity));a.force.clear()},this);d.each(b.particles,function(b,c){if(!b.fixed){var d=this.originalPositions[c],e=this.k2Velocities[c];b.position.set(d.x+0.5*e.x*
a,d.y+0.5*e.y*a);d=this.originalVelocities[c];e=this.k2Forces[c];b.velocity.set(d.x+0.5*e.x*a/b.mass,d.y+0.5*e.y*a/b.mass)}},this);b.applyForces();d.each(b.particles,function(a,b){a.fixed||(this.k3Forces[b].copy(a.force),this.k3Velocities[b].copy(a.velocity));a.force.clear()},this);d.each(b.particles,function(b,c){if(!b.fixed){var d=this.originalPositions[c],e=this.k3Velocities[c];b.position.set(d.x+e.x*a,d.y+e.y*a);d=this.originalVelocities[c];e=this.k3Forces[c];b.velocity.set(d.x+e.x*a/b.mass,d.y+
e.y*a/b.mass)}},this);b.applyForces();d.each(b.particles,function(a,b){a.fixed||(this.k4Forces[b].copy(a.force),this.k4Velocities[b].copy(a.velocity))},this);d.each(b.particles,function(b,c){b.age+=a;if(!b.fixed){var d=this.originalPositions[c],e=this.k1Velocities[c],f=this.k2Velocities[c],g=this.k3Velocities[c],k=this.k4Velocities[c],m=d.x+a/6*(e.x+2*f.x+2*g.x+k.x),d=d.y+a/6*(e.y+2*f.y+2*g.y+k.y);b.position.set(m,d);d=this.originalVelocities[c];e=this.k1Forces[c];f=this.k2Forces[c];g=this.k3Forces[c];
k=this.k4Forces[c];m=d.x+a/(6*b.mass)*(e.x+2*f.x+2*g.x+k.x);d=d.y+a/(6*b.mass)*(e.y+2*f.y+2*g.y+k.y);b.velocity.set(m,d)}},this);return this}});return f}(common),requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c){window.setTimeout(c,1E3/60)}}(),common);