/**
 * Physics
 * A requirified port of Traer Physics from Processing to JavaScript.
 * Copyright (C) 2012 jonobr1
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
var physics=physics||{};
common=function(){var d=Array.prototype,e=Object.prototype.hasOwnProperty,a=d.slice,c=d.forEach,b=function(b,a,h){if(null!=b)if(c&&b.forEach===c)b.forEach(a,h);else if(b.length===+b.length)for(var f=0,m=b.length;f<m&&!(f in b&&a.call(h,b[f],f,b)===breaker);f++);else for(f in b)if(_.has(b,f)&&a.call(h,b[f],f,b)===breaker)break};return{has:function(b,a){return e.call(b,a)},each:b,extend:function(g){b(a.call(arguments,1),function(b){for(var a in b)g[a]=b});return g},isNumber:function(b){return"[object Number]"==toString.call(b)},
isFunction:function(b){return"[object Function]"==toString.call(b)}}}();
physics.System=System=function(d,e,a){function c(){var b=this;console.log(this);this.tick();a.each(this.animations,function(b){a.isFunction(b.update)&&b.update()});this.__equilibrium||e(function(){c.call(b)})}var b=function(){d.ParticleSystem.apply(this,arguments);this.animations=[]};b.Traer=d;a.extend(b.prototype,d.ParticleSystem.prototype,{update:function(){this.__equilibrium&&(this.__equilibrium=!1,c.call(this));return this}});b=new b;c.call(b);return b}(Traer=function(d,e){function a(b){this.s=
b;this.originalPositions=[];this.originalVelocities=[];this.k1Forces=[];this.k1Velocities=[];this.k2Forces=[];this.k2Velocities=[];this.k3Forces=[];this.k3Velocities=[];this.k4Forces=[];this.k4Velocities=[]}var c={Particle:function(b){this.position=new d;this.velocity=new d;this.force=new d;this.mass=b;this.fixed=!1;this.age=0;this.dead=!1}};e.extend(c.Particle.prototype,{distanceTo:function(b){return this.position.distanceTo(b.position)},makeFixed:function(){this.fixed=!0;this.velocity.clear()},
reset:function(){this.age=0;this.dead=!1;this.position.clear();this.velocity.clear();this.force.clear();this.mass=1},resting:function(){return this.fixed||this.velocity.isZero()&&this.force.isZero()}});c.Spring=function(b,g,a,c,f){this.constant=a;this.damping=c;this.length=f;this.a=b;this.b=g;this.on=!0};e.extend(c.Spring.prototype,{currentLength:function(){return this.a.position.distanceTo(this.b.position)},update:function(){var b=this.a,g=this.b;if(!this.on||b.fixed&&g.fixed)return this;var a=(new d).sub(b.position,
g.position),c=a.length();0===c?a.clear():a.divideScalar(c);var c=-1*(c-this.length)*this.constant,f=(new d).sub(b.velocity,g.velocity),f=-1*this.damping*f.dot(a);a.multiplyScalar(c+f);b.fixed||b.force.addSelf(a);g.fixed||g.force.subSelf(a);return this},resting:function(){var b=this.a,a=this.b,c=this.length;return b.fixed&&a.fixed||b.fixed&&(0===c?a.position.equals(b.position):a.position.distanceTo(b.position)<=c)&&a.resting()||a.fixed&&(0===c?b.position.equals(a.position):b.position.distanceTo(a.position)<=
c)&&b.resting()}});c.Attraction=function(b,a,c,d){this.a=b;this.b=a;this.constant=c;this.on=!0;this.distanceMin=d;this.distanceMinSquared=d*d};e.extend(c.Attraction.prototype,{update:function(){var b=this.a,a=this.b;if(this.on&&(!b.fixed||!a.fixed)){var c=(new d).sub(b.position,a.position),e=Math.max(c.lengthSq(),this.distanceMinSquared),f=this.constant*b.mass*a.mass/e,e=Math.sqrt(e);0===f||0===e?c.clear():c.divideScalar(e).multiplyScalar(f);b.fixed||b.force.subSelf(c);a.fixed||a.force.addSelf(c);
return this}},resting:function(){var b=this.a,a=this.b,c=this.distanceMin;return b.fixed&&a.fixed||b.fixed&&a.position.distanceTo(b.position)<=c&&a.resting()||a.fixed&&b.position.distanceTo(a.position)<=c&&b.resting()}});c.ParticleSystem=function(){this.__equilibrium=!1;this.particles=[];this.springs=[];this.attractions=[];this.forces=[];this.integrator=new a(this);this.hasDeadParticles=!1;var b=arguments.length;2===b?(this.gravity=new d(0,arguments[0]),this.drag=arguments[1]):3===b?(this.gravity=
new d(arguments[0],arguments[1]),this.drag=arguments[3]):(this.gravity=new d(0,c.ParticleSystem.DEFAULT_GRAVITY),this.drag=c.ParticleSystem.DEFAULT_DRAG)};e.extend(c.ParticleSystem,{DEFAULT_GRAVITY:0,DEFAULT_DRAG:0.001});e.extend(c.ParticleSystem.prototype,{setGravity:function(b,a){this.gravity.set(b,a);return this},tick:function(){this.integrator.step(0===arguments.length?1:arguments[0]);this.__equilibrium=!this.needsUpdate();return this},needsUpdate:function(){needsUpdate=!1;for(var b=0,a=this.springs.length;b<
a;b++)if(!this.springs[b].resting()){needsUpdate=!0;break}if(!needsUpdate){b=0;for(a=this.attractions.length;b<a;b++)if(!this.attractions[b].resting()){needsUpdate=!0;break}}return needsUpdate},addParticle:function(b){this.particles.push(b);return this},addSpring:function(b){this.springs.push(b);return this},addAttraction:function(b){this.attractions.push(b);return this},makeParticle:function(b,a,d){b=e.isNumber(b)?b:1;a=a||0;d=d||0;b=new c.Particle(b);b.position.set(a,d);this.addParticle(b);return b},
makeSpring:function(b,a,d,e,f){b=new c.Spring(b,a,d,e,f);this.addSpring(b);return b},makeAttraction:function(b,a,d,e){b=new c.Attraction(b,a,d,e);this.addAttraction(b);return b},clear:function(){this.particles.length=0;this.springs.length=0;this.attractions.length=0},applyForces:function(){this.gravity.isZero()||e.each(this.particles,function(b){b.force.addSelf(this.gravity)},this);var b=new d;e.each(this.particles,function(a){b.set(-1*a.velocity.x*this.drag,-1*a.velocity.y*this.drag);a.force.addSelf(b)},
this);e.each(this.springs,function(b){b.update()});e.each(this.attractions,function(b){b.update()});e.each(this.forces,function(b){b.update()});return this},clearForces:function(){e.each(this.particles,function(b){b.clear()});return this}});e.extend(a.prototype,{allocateParticles:function(){for(;this.s.particles.length>this.originalPositions.length;)this.originalPositions.push(new d),this.originalVelocities.push(new d),this.k1Forces.push(new d),this.k1Velocities.push(new d),this.k2Forces.push(new d),
this.k2Velocities.push(new d),this.k3Forces.push(new d),this.k3Velocities.push(new d),this.k4Forces.push(new d),this.k4Velocities.push(new d);return this},step:function(b){var a=this.s,c,d;this.allocateParticles();e.each(a.particles,function(b,a){b.fixed||(this.originalPositions[a].copy(b.position),this.originalVelocities[a].copy(b.velocity));b.force.clear()},this);a.applyForces();e.each(a.particles,function(b,a){b.fixed||(this.k1Forces[a].copy(b.force),this.k1Velocities[a].copy(b.velocity));b.force.clear()},
this);e.each(a.particles,function(a,e){if(!a.fixed){var i=this.originalPositions[e],j=this.k1Velocities[e];c=i.x+0.5*j.x*b;d=i.y+0.5*j.y*b;a.position.set(c,d);i=this.originalVelocities[e];j=this.k1Forces[e];c=i.x+0.5*j.x*b/a.mass;d=i.y+0.5*j.y*b/a.mass;a.velocity.set(c,d)}},this);a.applyForces();e.each(a.particles,function(b,a){b.fixed||(this.k2Forces[a].copy(b.force),this.k2Velocities[a].copy(b.velocity));b.force.clear()},this);e.each(a.particles,function(a,c){if(!a.fixed){var d=this.originalPositions[c],
e=this.k2Velocities[c];a.position.set(d.x+0.5*e.x*b,d.y+0.5*e.y*b);d=this.originalVelocities[c];e=this.k2Forces[c];a.velocity.set(d.x+0.5*e.x*b/a.mass,d.y+0.5*e.y*b/a.mass)}},this);a.applyForces();e.each(a.particles,function(b,a){b.fixed||(this.k3Forces[a].copy(b.force),this.k3Velocities[a].copy(b.velocity));b.force.clear()},this);e.each(a.particles,function(a,c){if(!a.fixed){var d=this.originalPositions[c],e=this.k3Velocities[c];a.position.set(d.x+e.x*b,d.y+e.y*b);d=this.originalVelocities[c];e=
this.k3Forces[c];a.velocity.set(d.x+e.x*b/a.mass,d.y+e.y*b/a.mass)}},this);a.applyForces();e.each(a.particles,function(b,a){b.fixed||(this.k4Forces[a].copy(b.force),this.k4Velocities[a].copy(b.velocity))},this);e.each(a.particles,function(a,c){a.age+=b;if(!a.fixed){var d=this.originalPositions[c],e=this.k1Velocities[c],g=this.k2Velocities[c],k=this.k3Velocities[c],l=this.k4Velocities[c],h=d.x+b/6*(e.x+2*g.x+2*k.x+l.x),d=d.y+b/6*(e.y+2*g.y+2*k.y+l.y);a.position.set(h,d);d=this.originalVelocities[c];
e=this.k1Forces[c];g=this.k2Forces[c];k=this.k3Forces[c];l=this.k4Forces[c];h=d.x+b/(6*a.mass)*(e.x+2*g.x+2*k.x+l.x);d=d.y+b/(6*a.mass)*(e.y+2*g.y+2*k.y+l.y);a.velocity.set(h,d)}},this);return this}});return c}(Vector=function(d){var e=function(a,c){this.x=a||0;this.y=c||0};d.extend(e.prototype,{set:function(a,c){this.x=a;this.y=c;return this},copy:function(a){this.x=a.x;this.y=a.y;return this},clear:function(){this.y=this.x=0;return this},clone:function(){return new e(this.x,this.y)},add:function(a,
c){this.x=a.x+c.x;this.y=a.y+c.y;return this},addSelf:function(a){this.x+=a.x;this.y+=a.y;return this},sub:function(a,c){this.x=a.x-c.x;this.y=a.y-c.y;return this},subSelf:function(a){this.x-=a.x;this.y-=a.y;return this},multiplySelf:function(a){this.x*=a.x;this.y*=a.y;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;return this},divideScalar:function(a){a?(this.x/=a,this.y/=a):this.set(0,0);return this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+
this.y*a.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var c=this.x-a.x,a=this.y-a.y;return c*c+a*a},setLength:function(a){return this.normalize().multiplyScalar(a)},equals:function(a){return 1E-4>this.distanceTo(a)},lerp:function(a,c){return this.set((a.x-this.x)*c+this.x,(a.y-
this.y)*c+this.y)},isZero:function(){return 1E-4>this.lengthSq()}});return e}(common),common),requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(d){window.setTimeout(d,1E3/60)}}(),common);